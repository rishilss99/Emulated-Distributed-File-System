<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<!-- <p>File System:</p> -->

<!DOCTYPE html>
<!-- Created By CodingNepal -->
<html lang="en" dir="ltr">
   <head>
      <link rel="stylesheet" href="static/css/style.css">
   </head>
   <body>
      <nav>
         <div class="logo">
            File Sytem Interface
         </div>
         <input type="checkbox" id="click">
         <label for="click" class="menu-btn">
         <i class="fas fa-bars"></i>
         </label>
      </nav>
   </body>
</html>

<style>
    body {
        margin: 0px;
        font-family: Arial, Helvetica, sans-serif;
    }
    /* * {box-sizing: border-box;} */
        
    #context-menu {
        position: fixed;
        z-index: 10000;
        width: 150px;
        background: #1b1a1a;
        transform: scale(0);
        transform-origin: top left;
    }

    #context-menu.active {
        transform: scale(1);
        transition: transform 200ms ease-in-out;
    }

    #context-menu .item {
        padding: 8px 10px;
        font-size: 15px;
        color: #eee;
    }

    #context-menu .item:hover {
        background: #555;
    }

    #context-menu .item i {
        display: inline-block;
        margin-right: 5px;
    }

    #context-menu hr {
        margin: 2px 0px;
        border-color: #555;
    }

    .form-popup {
      display: none;
      position: fixed;
      bottom: 200px;
      top:80px;
      right: 0px;
      left: 2px;
      border: 3px solid #f1f1f1;
      z-index: 9;
    }
    
    .form-container {
      max-width: 300px;
      padding: 10px;
      background-color: white;
    }

    .form-container input[type=text], .form-container input[type=password] {
      width: 100%;
      padding: 15px;
      margin: 5px 0 22px 0;
      border: none;
      background: #f1f1f1;
    }

    .form-container input[type=text]:focus, .form-container input[type=password]:focus {
      background-color: #ddd;
      outline: none;
    }
    
    .form-container .btn:hover, .open-button:hover {
      opacity: 1;
    
    }
    .btn1, .btn2, .btn3, .btn4 {
      background-color: grey; /* Green */
      border: none;
      color: white;
      width: 145px;
      height: 50px;
      padding: 15px 32px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 20px;
      margin: 4px 2px;
      cursor: pointer;
   }

</style>

<button id="back" type="button" class="btn2"><i id="back"></i> Back</button>
<button id="createFolder" type="button" class="btn3" onclick="createFolderClick()"></i>newFolder</button>

<!-- The form -->
<div class="form-popup" id="myForm">
    <form class="form-container">
  
      <label for="folderName"><b>Folder Name</b></label>
      <input id="dirForm" type="text" placeholder="Enter folder name" name="folderName" required>
  
      <button id="create" type="button" class="btn create" onclick="createDir()">Create</button>
      <button id="close" type="button" class="btn cancel" onclick="closeForm()">Close</button>
    </form>
</div>

<div class="form-popup" id="searchForm">
    <form class="form-container">
  
      <label for="method_name"><b>Search by</b></label>
      <br></br>
      <label for="stock_name">Name of Stock:</label><br>
      <!-- <input id="stock_name" type="text" placeholder="Enter stock name" name="stock_name" required> -->
      <select name="stock_name" id="stock_name">
	  </select>
      <br></br>
      <label for="method_name">Method:</label><br>
      <!-- <input id="method_name" type="text" placeholder="Enter method name" name="method_name" required> -->
      <select name="method_name" id="method_name">
      </select>
      <br></br>
      <label for="attribute_name">Attribute:</label><br>
      <!-- <input id="attribute_name" type="text" placeholder="Enter attribute" name="attribute_name" required> -->
      <select name="attribute_name" id="attribute_name">
      </select>
      <br></br>
  
      <button id="close" type="button" class="btn cancel" onclick="filterSearch()">Filter</button>
      <button id="close" type="button" class="btn cancel" onclick="closeSearchForm()">Close</button>
      <div id="SearchTable"></div>
      <br></br>
    </form>
</div>



<div id="context-menu"> 
    <div class="item">
        <i class="fa fa-cut"></i> Remove
    </div>
</div>

<br></br>
<button id="main_root" type="button" class="btn1" onclick="createPage('/')"><i class="fa fa-folder" id="main_root"></i> Root</button>
<div id="dvTable"></div>

<script>
    let URL = "http://127.0.0.1:5000/interface"
    let URL_search = "http://127.0.0.1:5000/search";
    let URL_analytics= "http://127.0.0.1:5000/analytics";
    let curDir;

    function createPage(cwd) {
        curDir = cwd;
        console.log("current directory is:", curDir);
        let identifier = 'ls';
        postRequest(URL, cwd, identifier).then(data => {
            let {buttons, button_ids} = createButton(data);
            if(cwd == '/'){
                document.getElementById('back').onclick = function(){
                    document.location.reload(true);

                };
                // set back onclick 
            }
            else {
                pwd = cwd.split('/').slice(0, -1).join('/')
                if(pwd == '') { 
                    pwd = '/' 
                }
                document.getElementById("back").onclick = function(){
                    createPage(pwd)
                    var divTable = document.getElementById("dvTable");
                    divTable.style.display = "none";
                    document.getElementById("createFolder").disabled = false;
                };
                // set onclick for back button 
            }
            for (let i = 0; i < buttons.length; i++) {
                let pwd = ''
                if(cwd == '/'){
                    pwd = cwd + buttons[i];
                } else {
                    pwd = cwd + '/' + buttons[i];
                }
                document.getElementById(button_ids[i]).onclick = function(){
                    console.log(button_ids[i]);
                    if (button_ids[i].endsWith(".csv") === true) { 
                        var divTable = document.getElementById("dvTable");
                        let search_data = ["Cat", "Search", "Analyze"];
                        let {buttons, button_ids} = createButton(search_data);
                        console.log(button_ids);
                        let hidebuttons_search = ["back", "createFolder", button_ids[0], button_ids[1]];
                        console.log(hidebuttons_search);
                        for (const butId of button_ids) {
                            button_ids_split = butId.split("_");
                            if (button_ids_split[1] == "Search") {
                                document.getElementById(button_ids[1]).onclick = function() {
                                    var identifier = "search";
                                    divTable.style.display = "none";
                                    searchForm();
                                    getDropDownMenu(pwd);
                                    console.log(pwd);
                                    curDir = pwd;
                                }
                                document.getElementById("close").onclick = function() {
                                    filterSearch(pwd);
                                }
                            }
                            else if (button_ids_split[1] == "Analyze"){
                                document.getElementById(button_ids[2]).onclick = function() {
                                    divTable.style.display = "none";
                                    window.location.assign(URL_analytics);
                                }
                            }
                            else if (button_ids_split[1] == "Cat") {
                                document.getElementById(button_ids[0]).onclick = function() {
                                    let identifier = "cat";
                                    GenerateTable(URL, pwd, identifier);
                                    divTable.style.display = "block";
                                    document.getElementById("createFolder").disabled = true;
                                    document.querySelectorAll('.btn1').forEach(elem => {
                                        elem.style.display = "none";
                                    });
                                }              
                            }
                        }
                    }
                    else{
                        document.getElementById("createFolder").disabled = false;
                        createPage(pwd)
                    }
                };
                var buttonRightClick = document.getElementById(button_ids[i]);
                buttonRightClick.addEventListener("contextmenu", function(event) {
                    event.preventDefault();
                    var contextelement = document.getElementById("context-menu");
                    contextelement.style.top = mouseY(event) + "px";
                    contextelement.style.left = mouseX(event) + "px";
                    contextelement.classList.add("active");
                    rightClickedButton = button_ids[i].substring(button_ids[i].indexOf("_")+1);
                    console.log("button on which right click was done is", rightClickedButton);
                    if (curDir == "/"){
                        curDir = curDir + rightClickedButton;
                    }
                    else {
                        curDir = curDir + "/" + rightClickedButton;
                    }              
                })
            }
        })
    }

    function closeForm() {
        document.getElementById("myForm").style.display = "none";
    }

    function filterSearch(){
        let identifier = 'search';
        console.log("inside create folder curDir variable:", curDir);
        var stock_name = document.getElementById("stock_name").value;
        console.log(stock_name);
        var method_name = document.getElementById("method_name").value;
        var attribute_name = document.getElementById("attribute_name").value;
        postRequestSearch(URL_search, curDir, identifier, stock_name, method_name, attribute_name).then(data => {
            console.log("printing post request data:", data);
            var customers = new Array();
            console.log(typeof(data));
            for (const x of data) {
                column_values = x.split(" ");
                customers.push(column_values);
            }
    
            var table = document.createElement("TABLE");
            table.border = "1";
    
            var columnCount = customers[0].length;
    
            var row = table.insertRow(-1);
            for (var i = 0; i < columnCount; i++) {
                var headerCell = document.createElement("TH");
                headerCell.innerHTML = customers[0][i];
                row.appendChild(headerCell);
            }
    
        
            for (var i = 1; i < customers.length; i++) {
                row = table.insertRow(-1);
                for (var j = 0; j < columnCount; j++) {
                    var cell = row.insertCell(-1);
                    cell.innerHTML = customers[i][j];
                }
            }
    
            var SearchTable = document.getElementById("SearchTable");
            SearchTable.innerHTML = "";
            SearchTable.appendChild(table);
            var searchTable = document.getElementById("SearchTable");
            searchTable.style.display = "block";

        })

        console.log("generated table"); 

    }

    function getDropDownMenu(pwd) {
        let identifier = "dropdown";
        console.log("path for dropdown pwd:", pwd);
        postRequest(URL_search, pwd, identifier).then(options => {
            console.log("printing dropdown request data", options);
            var stock_name_menus = generateDropdowns(options[0]);
            var method_name_menus = generateDropdowns(options[1]);
            var attribute_name_menus = generateDropdowns(options[2]);
            console.log(stock_name_menus, method_name_menus, attribute_name_menus);
            document.getElementById("stock_name").innerHTML = stock_name_menus;
            document.getElementById("method_name").innerHTML = method_name_menus;
            document.getElementById("attribute_name").innerHTML = attribute_name_menus;
        });
    }

    function generateDropdowns(options){
        var selectHtml = "";
        for(var optionIndex = 0; optionIndex < options.length; optionIndex++) {

            selectHtml += ("<option>" + options[optionIndex] + "</option>");

        }
        return selectHtml;
    }

    function createDir(cwd) {
        let identifier = 'mkdir';
        console.log("inside create folder curDir variable:", curDir);
        var name = document.getElementById("dirForm").value;
        let full_path;
        if (curDir == "/") {
            full_path = curDir + name;
        }
        else {
            full_path = curDir + "/" + name;
        }
        console.log("full path is, ", full_path);
        postRequest(URL, full_path, identifier).then(data => {
            console.log("printing post request data:", data);
            createPage(full_path);
        })
    }

    function createFolderClick() {
        document.getElementById("myForm").style.display = "block";
    }

    function closeSearchForm(){
        document.getElementById("searchForm").style.display = "none";
        var searchTable = document.getElementById("SearchTable");
        searchTable.style.display = "none";
        document.getElementById("createFolder").disabled = false;
    }

    function searchForm() {
        document.getElementById("searchForm").style.display = "block";
    }

    function removeDir(dir_path, remove_name) {
        let identifier = "rm";
        console.log("directory to be removed is", dir_path);
        console.log("file/dir to be removed", remove_name);
        const final_path  = dir_path.replace(remove_name, '');
        console.log("final path after removing dir/file is", final_path);
        postRequest(URL, dir_path, identifier).then(data => {
            console.log("printing post request data", data);
            createPage(final_path);
        })

    }

    var onRemove = document.getElementById("context-menu");
    onRemove.addEventListener("click", function() {
        let remove_name = curDir.substring(curDir.lastIndexOf('/') + 1);
        file_extension = remove_name.substring(remove_name.lastIndexOf(".") + 1);
        console.log(file_extension);
        removeDir(curDir, remove_name);
    })


    function hideButtons(data) {
        var i = document.getElementsByTagName("button");
        for(var n in i){
            if ((data.includes(i[n].id))){
                i[n].style.visibility = "visible";  
            }
            else if ((i[n].id == "back") || (i[n].id == "createFolder")
            || (i[n].id == "create") || (i[n].id == "close")) {
                i[n].style.visibility = "visible";
            }
            else if (i[n].id == undefined) {
                break;
            }
            else {
                i[n].style.display = "none";
            }
        }
    }

    function createButton(data) {
        let button_ids = []
        let buttons = []

        for (const x of data) {
            const button = document.createElement("button");
            let uid = generateUniqueIds();
            uid_string = uid.toString() + "_" + x;
            button.setAttribute("id", uid_string);
            button.innerHTML = x;
            document.body.appendChild(button);
            button.style.display = "block";

            if (x.includes(".")) {
                button.className = "fa fa-file";
            }
            else {
                button.className = "fa fa-folder";
            } 
            button.classList.add("btn1");
            button.classList.add("btn4");

            button_ids.push(uid_string);
            buttons.push(uid_string.split("_")[1]);
        }
        hideButtons(button_ids);
        return {buttons, button_ids};
    }

    function generateUniqueIds() {
        var minm = 100000;
        var maxm = 999999;
        return Math.floor(Math.random() * (maxm - minm + 1)) + minm;
    }

    window.addEventListener("click", function() {
        document.getElementById("context-menu").classList.remove("active");
    })

    function mouseX(evt) {
        if (evt.pageX) {
            return evt.pageX;
        } else if (evt.clientX) {
            return evt.clientX + (document.documentElement.scrollLeft ?
            document.documentElement.scrollLeft :
            document.body.scrollLeft);
        } else {
            return null;
        }
    }

    function mouseY(evt) {
        if (evt.pageY) {
            return evt.pageY;
        } else if (evt.clientY) {
            return evt.clientY + (document.documentElement.scrollTop ?
            document.documentElement.scrollTop :
            document.body.scrollTop);
        } else {
            return null;
        }
    }

    function GenerateTable(url, dir_path, identifier){
        console.log("path for cat is:", dir_path);
        postRequest(url, dir_path, identifier).then(data => {
            console.log("search query post request data:::::::", data);
            var customers = new Array();
            console.log(typeof(data));
            for (const x of data) {
                column_values = x.split(" ");
                customers.push(column_values);
            }
    
            var table = document.createElement("TABLE");
            table.border = "1";
    
            var columnCount = customers[0].length;
    
            var row = table.insertRow(-1);
            for (var i = 0; i < columnCount; i++) {
                var headerCell = document.createElement("TH");
                headerCell.innerHTML = customers[0][i];
                row.appendChild(headerCell);
            }
    
        
            for (var i = 1; i < customers.length; i++) {
                row = table.insertRow(-1);
                for (var j = 0; j < columnCount; j++) {
                    var cell = row.insertCell(-1);
                    cell.innerHTML = customers[i][j];
                }
            }
    
            var dvTable = document.getElementById("dvTable");
            dvTable.innerHTML = "";
            dvTable.appendChild(table);
        })
    }


    async function postRequest(url, id, identifier) {
        let data = {"command" : id,
                    "identifier" : identifier};
        let res = await fetch(url, {
                method: 'POST',
                headers: {
                        'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
        });
        console.log('TEST', res, res.ok)
        if (res.ok) {
            let ret = await res.json();
            return ret.response;

        } else {
            return `HTTP error: ${res.status}`;
        }
    }


    async function postRequestSearch(url, id, identifier, stock_name, method_name, attribute_name){
        let data = {"command" : id,
                    "identifier" : identifier,
                    "stock_name": stock_name,
                    "method_name": method_name,
                    "attribute_name": attribute_name};
        let res = await fetch(url, {
                method: 'POST',
                headers: {
                        'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
        });
        if (res.ok) {
            let ret = await res.json();
            return ret.response;

        } else {
            return `HTTP error: ${res.status}`;
        }
    }


</script>