<html>
  <body>
    <label for="dataset_name">Choose Dataset:</label><br>
    <select name="dataset_name" id="dataset_name">
        <option value = "Population Data"> Population Data   
        </option>  
        <option value = "Housing Data"> Housing Data   
        </option>  
        <option value = "Stocks Data"> Stocks Data  
        </option>  
    </select> 
    <button type="submit" name="choose" onclick="selectDataset()">Select</button>
    <br></br>
    <label for="attribute_name">Attribute Name:</label><br>
    <select name="attribute_name" id="attribute_name"></select>
    <br></br>

    <button type="submit" name="choose" onclick="analyseDataset()">Analyze</button>
    
    
    <div id="barchart_material" style="width: 900px; height: 3000px;"></div>
    
  </body>
  <head>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      let URL_analytics= "http://127.0.0.1:5000/analytics";

      function selectDataset() {
        let identifier = "analyze";
        var dataset_option = document.getElementById("dataset_name").value;
        var attribute_option = document.getElementById("attribute_name").value;
        if (dataset_option != "Stock Data") {
          postRequest(URL_analytics, dataset_option, identifier).then(data => {
            getDropDownMenu(data[0]);
          })
        }
      }
      
      function analyseDataset() {
        let identifier = "analyze";
        var dataset_option = document.getElementById("dataset_name").value;
        var attribute_option = document.getElementById("attribute_name").value;
        postRequest(URL_analytics, dataset_option, identifier).then(data => {
          console.log("printing graph related data:", data);
          console.log(data[0]);
          getDropDownMenu(data[0]);
          index = data[0].indexOf(attribute_option);
          var dataset = data.map(d => [d[0], d[index]]);

          google.charts.load('current', {'packages':['bar']});
          google.charts.setOnLoadCallback(drawChart);

          function drawChart() {
            console.log(dataset);
            console.log(typeof(dataset));
            var data = google.visualization.arrayToDataTable(dataset);
            console.log(data);
            var options = {
              chart: {
              title: 'Population Dataset Analysis',
              subtitle: 'Sales, Expenses, and Profit: 2020',
            },
            bars: 'horizontal' // Required for Material Bar Charts.
          };

          var chart = new google.charts.Bar(document.getElementById('barchart_material'));

          chart.draw(data, google.charts.Bar.convertOptions(options));
        }
       
        })
      }
      
      function getDropDownMenu(options) {
        var attribute_name_menus = generateDropdowns(options);
        console.log(attribute_name_menus);
        document.getElementById("attribute_name").innerHTML = attribute_name_menus;
      }

      function generateDropdowns(options){
        var selectHtml = "";
        for(var optionIndex = 0; optionIndex < options.length; optionIndex++) {

            selectHtml += ("<option>" + options[optionIndex] + "</option>");

        }
        return selectHtml;
      }
      

      async function postRequest(url, option, identifier) {
        let data = {"command" : option,
                    "identifier": identifier};
        let res = await fetch(url, {
                method: 'POST',
                headers: {
                        'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
        });
        console.log('TEST', res, res.ok)
        if (res.ok) {
            let ret = await res.json();
            return ret.response;

        } else {
            return `HTTP error: ${res.status}`;
        }
      }
    </script>
  </head>
</html>