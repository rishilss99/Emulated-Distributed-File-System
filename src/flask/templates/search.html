<html>
  <body>
    <label for="dataset_name" class="dataset-field">Dataset Name:</label>
        <select name="dataset_name" id="dataset_name", class="dataset_name"> 
            <option value="" disabled selected>Choose your Dataset</option> 
            <option value = "Population Data" class="population"> Population Data   
            </option>  
            <option value = "Housing Data"> Housing Data   
            </option>  
            <option value = "Stocks Data"> Stocks Data  
            </option>  
        </select> 
    <button type="submit" name="choose" onclick="selectDataset()" class="btn">Select</button>
    <br></br>

    <div class="form-popup" id="searchFormStocks" hidden>
        <form class="form-container">
            <label for="method_name" class="search-by"><b>Search by</b></label>
            <br></br>
            <label for="stock_name" class="stock_name">Name of Stock:</label><br>

            <select name="stock_name" id="stock_name">
            </select>
            <br></br>
            <label for="method_name" class="method_name">Method:</label><br>

            <select name="method_name" id="method_name">
            </select>
            <br></br>
            <label for="attribute_name" class="attribute_name">Attribute:</label><br>

            <select name="attribute_name" id="attribute_name">
            </select>
            <br></br>
        
            <button id="close" type="button" class="btn cancel" onclick="filterSearch()">Filter</button>
            <button id="close" type="button" class="btn cancel" onclick="closeSearchForm()">Close</button>
            <div id="SearchTable"></div>
            <br></br>
        </form>
    </div>

    <div class="form-housing" id="searchFormHousing" hidden>
        <form class="form-container">
            <label for="search_house" class="search-house"><b>Search by</b></label>
            <br></br>
            <label for="state_name" class="state_name">Name of State:</label><br>
            <select name="state_name" id="state_name">
            </select>
            <br></br>
            <label for="method_name_house" class="method_name_house">Method:</label><br>
            <select name="method_name_house" id="method_name_house">
            </select>
            <br></br>
        
            <button id="close" type="button" class="btn cancel" onclick="filterSearch()">Filter</button>
            <button id="close" type="button" class="btn cancel" onclick="closeSearchForm()">Close</button>
            <div id="SearchTable"></div>
            <br></br>
        </form>
    </div>

    <style>

        .dataset-field, .search-by, .stock_name, .method_name, .attribute_name, .population {
            font: 1em Roboto, Helvetica, sans-serif;

        }

        select {
            border: none;
            -webkit-appearance: none;
            -ms-progress-appearance: none;
            appearance: none;
            background: #f2f2f2;
            padding: 12px;
            border-radius: 3px;
            width: 250px;
        }
  
        .btn{
        color:#fff;
        background-color:#e74c3c;
        outline: none;
        border: 0;
        color: #fff;
        padding:10px 20px;
        text-transform:uppercase;
        margin-top:50px;
        border-radius:2px;
        cursor:pointer;
        position:relative;
      }
  
      .input-container{
        position:relative;
        margin-bottom:25px;
      }
      .input-container label{
        position:absolute;
        top:0px;
        left:0px;
        font-size:16px;
        color:#fff;	
        pointer-event: none;
        transition: all 0.5s ease-in-out;
      }
      .input-container input{ 
        border:0;
        border-bottom:1px solid #555;  
        background:transparent;
        width:100%;
        padding:8px 0 5px 0;
        font-size:16px;
        color:#fff;
      }
      .input-container input:focus{ 
      border:none;	
      outline:none;
      border-bottom:1px solid #e74c3c;	
      }

    </style>

    
  </body>
  <head>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      let URL_analytics= "http://127.0.0.1:5000/analytics";
      let URL_search = "http://127.0.0.1:5000/search";

      function selectDataset() {
        var identifier = "search";
        var dataset_option = document.getElementById("dataset_name").value;
        var identifier = "search";
        // divTable.style.display = "none";
        if (dataset_option == "Population Data") {
            pwd = "population.csv";
        }
        else if (dataset_option == "Housing Data") {
            pwd = "house.csv";
        }
        else if (dataset_option == "Stocks Data") {
            pwd = "stocks.csv";
        }
        searchForm(dataset_option);
        getDropDownMenu(pwd, dataset_option);
        console.log(pwd);
        curDir = pwd;
        document.getElementById("close").onclick = function() {
            filterSearch(pwd);
        }
      }
      

      function filterSearch(){
        let identifier = 'search';
        console.log("inside create folder curDir variable:", curDir);
        var stock_name = document.getElementById("stock_name").value;
        console.log(stock_name);
        var method_name = document.getElementById("method_name").value;
        var attribute_name = document.getElementById("attribute_name").value;
        postRequestSearch(URL_search, curDir, identifier, stock_name, method_name, attribute_name).then(data => {
            console.log("printing post request data:", data);
            var customers = new Array();
            console.log(typeof(data));
            for (const x of data) {
                column_values = x.split(" ");
                customers.push(column_values);
        }
    
        var table = document.createElement("TABLE");
        table.border = "1";

        var columnCount = customers[0].length;

        var row = table.insertRow(-1);
        for (var i = 0; i < columnCount; i++) {
            var headerCell = document.createElement("TH");
            headerCell.innerHTML = customers[0][i];
            row.appendChild(headerCell);
        }
    
        
        for (var i = 1; i < customers.length; i++) {
            row = table.insertRow(-1);
            for (var j = 0; j < columnCount; j++) {
                var cell = row.insertCell(-1);
                cell.innerHTML = customers[i][j];
            }
        }

        var SearchTable = document.getElementById("SearchTable");
        SearchTable.innerHTML = "";
        SearchTable.appendChild(table);
        var searchTable = document.getElementById("SearchTable");
        searchTable.style.display = "block";

        })

        console.log("generated table"); 
    }

    function getDropDownMenu(pwd, dataset_option) {
        let identifier = "dropdown";
        console.log("path for dropdown pwd:", pwd);
        postRequest(URL_search, pwd, identifier).then(options => {
            console.log("printing dropdown request data", options);
            console.log("printing option")
            if (dataset_option == "Stocks Data") {
                var stock_name_menus = generateDropdowns(options[0]);
                var method_name_menus = generateDropdowns(options[1]);
                var attribute_name_menus = generateDropdowns(options[2]);
                console.log(stock_name_menus, method_name_menus, attribute_name_menus);
                document.getElementById("stock_name").innerHTML = stock_name_menus;
                document.getElementById("method_name").innerHTML = method_name_menus;
                document.getElementById("attribute_name").innerHTML = attribute_name_menus;
            }
            else if (dataset_option == "Housing Data") {
                var state_name_menus = generateDropdowns(options[0]);
                var method_name_house_menus = generateDropdowns(options[1]);
                console.log(state_name_menus, method_name_house_menus);
                document.getElementById("state_name").innerHTML = state_name_menus;
                document.getElementById("method_name_house").innerHTML = method_name_house_menus;
            }
            
        });
    }

    function generateDropdowns(options){
        var selectHtml = "";
        for(var optionIndex = 0; optionIndex < options.length; optionIndex++) {

            selectHtml += ("<option>" + options[optionIndex] + "</option>");

        }
        return selectHtml;
    }

    function closeSearchForm(){
        document.getElementById("searchFormStocks").style.display = "none";
        document.getElementById("searchFormHousing").style.display = "none";
        var searchTable = document.getElementById("SearchTable");
        searchTable.style.display = "none";
    }

    function searchForm(dataset_option) {
        if (dataset_option == "Housing Data"){
            document.getElementById("searchFormHousing").style.display = "block";
            document.getElementById("searchFormStocks").style.display = "none";
        }
        else if (dataset_option == "Stocks Data"){
            document.getElementById("searchFormStocks").style.display = "block";
            document.getElementById("searchFormHousing").style.display = "none";
        }
        else{
            document.getElementById("searchFormStocks").style.display = "block";
        }  
    }

    async function postRequestSearch(url, id, identifier, stock_name, method_name, attribute_name){
        let data = {"command" : id,
                    "identifier" : identifier,
                    "stock_name": stock_name,
                    "method_name": method_name,
                    "attribute_name": attribute_name};
        let res = await fetch(url, {
                method: 'POST',
                headers: {
                        'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
        });
        if (res.ok) {
            let ret = await res.json();
            return ret.response;

        } else {
            return `HTTP error: ${res.status}`;
        }
    }
      

      async function postRequest(url, option, identifier) {
        let data = {"command" : option,
                    "identifier": identifier};
        let res = await fetch(url, {
                method: 'POST',
                headers: {
                        'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
        });
        console.log('TEST', res, res.ok)
        if (res.ok) {
            let ret = await res.json();
            return ret.response;

        } else {
            return `HTTP error: ${res.status}`;
        }
      }
    </script>
  </head>
</html>